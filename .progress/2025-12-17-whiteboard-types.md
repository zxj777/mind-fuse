# ç™½æ¿ç±»å‹ç³»ç»Ÿè®¾è®¡ - è¿›åº¦è®°å½•

> åˆ›å»ºæ—¶é—´: 2024-12-17
> æœ€åæ›´æ–°: 2024-12-19
> çŠ¶æ€: è¿›è¡Œä¸­ - ids.ts, geometry.ts, shapes.ts å·²å®Œæˆï¼Œå‡†å¤‡å®ç° bindings.ts
> ä¸‹æ¬¡å¼€å§‹ä½ç½®: å®ç° bindings.tsï¼ˆBinding ç±»å‹ + NormalizedPointï¼‰

---

## ä»Šæ—¥è®¨è®ºæ€»ç»“

### æ ¸å¿ƒæ¶æ„å†³ç­–ï¼ˆå·²ç¡®è®¤ï¼‰

| å†³ç­–ç‚¹ | é€‰æ‹© | ç†ç”± |
|--------|------|------|
| **æ•°æ®ç»“æ„é£æ ¼** | tldraw é£æ ¼ (parentId + index + props) | æˆç†Ÿæ–¹æ¡ˆï¼Œæ”¯æŒåˆ†ç»„å’Œå±‚çº§ |
| **è¿æ¥çº¿ç»‘å®š** | Bindings ç‹¬ç«‹ç®¡ç† | æ›´çµæ´»ï¼Œæ”¯æŒå¤šç§ç»‘å®šç±»å‹ï¼ŒCRDT å‹å¥½ |
| **å­å…ƒç´ åæ ‡** | ç›¸å¯¹äºçˆ¶å…ƒç´  | ç§»åŠ¨çˆ¶å…ƒç´ æ—¶å­å…ƒç´ è‡ªåŠ¨è·Ÿéš |
| **æ’åºç´¢å¼•** | Fractional indexing (å­—ç¬¦ä¸²) | æ”¯æŒååŒç¼–è¾‘ï¼Œæ— å†²çªæ’å…¥ |
| **å˜æ¢äº¤äº’** | åœºæ™¯ A - æ‰‹æŸ„è·Ÿéšæ—‹è½¬ (Figma/Miro æ¨¡å¼) | ç”¨æˆ·æœŸæœ›ï¼Œéœ€è¦é€†æ—‹è½¬å˜æ¢è®¡ç®— |
| **ID ç±»å‹æ–¹æ¡ˆ** | Branded Type (æ–¹æ¡ˆ B+ï¼Œå‚è€ƒ tldraw) | ç±»å‹å®‰å…¨ + æ’ä»¶æ‰©å±•æ€§ |

### 2024-12-18 æ–°å¢å†³ç­–

| å†³ç­–ç‚¹ | é€‰æ‹© | ç†ç”± |
|--------|------|------|
| **ååŒæ¨¡å¼** | Local-first + CRDT | å®æ—¶åä½œ + ç¦»çº¿å¯ç”¨ + å¤šè®¾å¤‡åŒæ­¥ |
| **CRDT å®ç°** | Yjs + é€‚é…å™¨å±‚ | ç”¨æˆç†Ÿåº“ï¼Œä¿ç•™è‡ªç ”ç©ºé—´ |
| **æ•°æ®å­˜å‚¨** | Map by IDï¼ˆéæ•°ç»„ï¼‰ | O(1) æŸ¥æ‰¾ï¼Œåˆ é™¤ä¸å½±å“å…¶ä»–å…ƒç´ ï¼ŒCRDT å‹å¥½ |
| **å˜æ¢å±æ€§** | å¹³é“ºï¼ˆx, y, rotation ç›´æ¥åœ¨é¡¶å±‚ï¼‰ | è®¿é—®æ›´ç›´æ¥ï¼Œå‚è€ƒ tldraw |
| **Store API** | é€šç”¨ CRUD + transaction | çµæ´»ï¼Œæ”¯æŒå¤åˆæ“ä½œä½œä¸ºåŸå­å•ä½ |
| **å˜æ›´é€šçŸ¥** | è®¢é˜…æ¨¡å¼ | è§£è€¦ï¼Œå¤šè®¢é˜…è€…ï¼ˆæ¸²æŸ“/Undo/ååŒï¼‰ |
| **Undo/Redo** | ä¸Šå±‚å¤„ç†ï¼ŒStore ä¸è´Ÿè´£å†å² | èŒè´£åˆ†ç¦» |
| **parentId ç©ºå€¼** | nullï¼ˆé undefinedï¼‰ | è¯­ä¹‰æ˜ç¡®ï¼ŒJSON åºåˆ—åŒ–å‹å¥½ |

### å®ç°è·¯çº¿ç¡®è®¤

**é€‰æ‹©äº†å‚ç›´åˆ‡ç‰‡ + é¢„è®¾è®¡æ··åˆæ–¹æ¡ˆ**ï¼š
- æ ¸å¿ƒæ•°æ®æ¨¡å‹ï¼ˆShape, Binding, Documentï¼‰é¢„å…ˆè®¾è®¡ï¼Œé¿å…å¤§è§„æ¨¡é‡æ„
- å®ç°ç»†èŠ‚ï¼ˆå…·ä½“ APIã€ç»„ä»¶ç»“æ„ï¼‰è¾¹åšè¾¹ä¼˜åŒ–
- æ¯ä¸ªå†³ç­–ç‚¹éƒ½é€šè¿‡"ä¸ºä»€ä¹ˆéœ€è¦å®ƒ"çš„é—®é¢˜é©±åŠ¨ï¼Œè€Œä¸æ˜¯ç›´æ¥ç»™ç­”æ¡ˆ

---

## å…³é”®æŠ€æœ¯ç‚¹å­¦ä¹ 

### 1. Fractional Indexing

**é—®é¢˜**ï¼šååŒç¼–è¾‘æ—¶ï¼Œä¸¤ä¸ªç”¨æˆ·åŒæ—¶åœ¨ A å’Œ B ä¹‹é—´æ’å…¥å…ƒç´ ï¼Œå¦‚ä½•é¿å…å†²çªï¼Ÿ

**è§£å†³æ–¹æ¡ˆ**ï¼š
```typescript
// æ•°å­—ç´¢å¼• - ä¼šå†²çª
A.index = 1, B.index = 2
ç”¨æˆ· X æ’å…¥ C: C.index = 1.5
ç”¨æˆ· Y æ’å…¥ D: D.index = 1.5  // ğŸ’¥ å†²çª

// å­—ç¬¦ä¸²ç´¢å¼• - æ— å†²çª
A.index = 'a0', B.index = 'a1'
ç”¨æˆ· X æ’å…¥ C: C.index = 'a0V'
ç”¨æˆ· Y æ’å…¥ D: D.index = 'a0G'
// å­—å…¸åºè‡ªåŠ¨æ’åºï¼ša0 < a0G < a0V < a1
```

### 2. Bindings ç‹¬ç«‹ç®¡ç†

**ä¸ºä»€ä¹ˆä¸æŠŠ boundTo ç›´æ¥å­˜åœ¨ Connector é‡Œï¼Ÿ**

```typescript
// æ–¹æ¡ˆ 1ï¼šç›´æ¥å¼•ç”¨ï¼ˆç®€å•ä½†ä¸çµæ´»ï¼‰
interface Connector {
  start: { boundTo: 'shape:rect-a' }
  end: { boundTo: 'shape:rect-b' }
}

// æ–¹æ¡ˆ 2ï¼šç‹¬ç«‹ Bindings è¡¨ï¼ˆå¤æ‚ä½†çµæ´»ï¼‰
interface Connector {
  start: { x: 300, y: 150 }
  end: { x: 500, y: 150 }
}
interface Binding {
  fromId: 'connector:1',
  toId: 'shape:rect-a',
  anchor: 'right'
}
```

**æ–¹æ¡ˆ 2 çš„ä¼˜åŠ¿**ï¼š
1. ä¸€ä¸ªç«¯ç‚¹å¯ä»¥æœ‰å¤šä¸ªç»‘å®šï¼ˆå¦‚åŒæ—¶ç»‘å®šåˆ° shape å’Œç½‘æ ¼ï¼‰
2. æ”¯æŒå¤šç§ç»‘å®šç±»å‹ï¼ˆè¿æ¥çº¿ã€æ ‡ç­¾ã€å°ºå¯¸æ ‡æ³¨ç­‰ï¼‰
3. CRDT ååŒæ—¶æ›´å®¹æ˜“å¤„ç†åˆ é™¤å†²çª

### 3. ID ç±»å‹å®‰å…¨ï¼ˆBranded Typeï¼‰

**tldraw çš„æ–¹æ¡ˆ**ï¼š
```typescript
// @tldraw/store
export type RecordId<R extends UnknownRecord> = string & { __type__: R }

// @tldraw/tlschema
export type TLShapeId = RecordId<TLUnknownShape>

export function createShapeId(id?: string): TLShapeId {
  return `shape:${id ?? uniqueId()}` as TLShapeId
}
```

**ä¸ºä»€ä¹ˆè¿™ä¸ªæ–¹æ¡ˆæœ€å¥½**ï¼š
- âœ… ç±»å‹å®‰å…¨ï¼šä¸èƒ½æŠŠ `UserId` ä¼ ç»™éœ€è¦ `ShapeId` çš„å‡½æ•°
- âœ… è¿è¡Œæ—¶çµæ´»ï¼šä»»ä½• `shape:xxx` æ ¼å¼éƒ½æ˜¯åˆæ³• ID
- âœ… æ’ä»¶å‹å¥½ï¼šç¬¬ä¸‰æ–¹å¯ä»¥è‡ªç”±ç”Ÿæˆè‡ªå®šä¹‰ shape ID
- âœ… é›¶è¿è¡Œæ—¶æˆæœ¬ï¼š`string & { __type__: R }` åªæ˜¯ç±»å‹æ ‡è®°

### 4. Shape ç±»å‹æ‰©å±•æ€§

**tldraw çš„æ–¹æ¡ˆ**ï¼š
```typescript
// å†…ç½® shapesï¼ˆå¼ºç±»å‹ï¼‰
export type TLDefaultShape = TLArrowShape | TLRectShape | ...

// è‡ªå®šä¹‰ shapesï¼ˆå®½æ¾ç±»å‹ï¼‰
export type TLUnknownShape = TLBaseShape<string, object>

// åˆå¹¶
export type TLShape = TLDefaultShape | TLUnknownShape
```

**ä¼˜åŠ¿**ï¼š
- å†…ç½® shapes æœ‰å®Œæ•´ç±»å‹æç¤ºå’Œè‡ªåŠ¨è¡¥å…¨
- æ’ä»¶å¯ä»¥æ³¨å†Œè‡ªå®šä¹‰ typeï¼Œç³»ç»Ÿèƒ½å¤„ç†
- TypeScript ä¼šæ ¹æ® `shape.type` è‡ªåŠ¨æ”¶çª„ç±»å‹

---

## å½“å‰åœæ­¢ä½ç½®

### å‡†å¤‡å·¥ä½œï¼ˆå·²å®Œæˆï¼‰
- âœ… ç†è§£ Miro å·¥å…·æ äº¤äº’æ¨¡å¼ï¼ˆä¸¤ç§ï¼šç‚¹å‡»å³ç”¨ã€æ‹–æ‹½ç»˜åˆ¶ï¼‰
- âœ… ç¡®è®¤æ•°æ®ç»“æ„æ–¹æ¡ˆï¼ˆtldraw é£æ ¼ï¼‰
- âœ… ç¡®è®¤ ID ç±»å‹æ–¹æ¡ˆï¼ˆBranded Typeï¼‰
- âœ… ç†è§£ä¸ºä»€ä¹ˆéœ€è¦ Fractional indexing
- âœ… ç†è§£ä¸ºä»€ä¹ˆ Bindings è¦ç‹¬ç«‹ç®¡ç†

### ä¸‹ä¸€æ­¥è¡ŒåŠ¨

**ä» Shape å®šä¹‰å¼€å§‹ï¼Œè‡ªç„¶æ¨å¯¼ç±»å‹ç³»ç»Ÿ**ï¼š

1. **èµ·ç‚¹**ï¼šå®šä¹‰ä¸€ä¸ªçŸ©å½¢çš„æ•°æ®ç»“æ„
   ```typescript
   const rect = {
     id: ???,
     type: 'rect',
     x: 100,
     y: 100,
     // è¿˜éœ€è¦ä»€ä¹ˆå­—æ®µï¼Ÿ
   }
   ```

2. **æ¨å¯¼è¿‡ç¨‹**ï¼ˆæ˜å¤©ç»§ç»­ï¼‰ï¼š
   - å®šä¹‰ Shape æ—¶å‘ç°éœ€è¦ `id` å­—æ®µ â†’ å¼•å‡º ID ç±»å‹å®šä¹‰
   - å¤šç§ shape éœ€è¦å…±äº«å­—æ®µ â†’ å¼•å‡º BaseShape æ³›å‹
   - éœ€è¦è¡¨ç¤ºä½ç½®å’Œå°ºå¯¸ â†’ å¼•å‡º geometry ç±»å‹ (Point, Box, Vec2)
   - éœ€è¦çˆ¶å­å…³ç³» â†’ å¼•å‡º parentId å’Œ index
   - è¿æ¥çº¿éœ€è¦ç»‘å®š â†’ å¼•å‡º Binding ç±»å‹
   - ç®¡ç†æ‰€æœ‰æ•°æ® â†’ å¼•å‡º Document ç±»å‹

3. **å®ç°é¡ºåº**ï¼ˆè‡ªç„¶æ¨å¯¼ï¼Œè€Œä¸æ˜¯é¢„è®¾ï¼‰ï¼š
   ```
   shape.ts (èµ·ç‚¹)
     â†“ å‘ç°éœ€è¦ id
   ids.ts
     â†“ å‘ç°éœ€è¦å‡ ä½•ç±»å‹
   geometry.ts
     â†“ å‘ç°éœ€è¦ Binding
   binding.ts
     â†“ å‘ç°éœ€è¦ Document
   document.ts
     â†“ æ±‡æ€»å¯¼å‡º
   index.ts
   ```

---

## å¾…è§£å†³çš„é—®é¢˜

### 1. geometry ç±»å‹çš„ç²’åº¦

**é—®é¢˜**ï¼šWeek 1 å®ç°åˆ°ä»€ä¹ˆç¨‹åº¦ï¼Ÿ

**é€‰é¡¹ A - æœ€å°åŒ–**ï¼š
- Point: `{ x: number, y: number }`
- Box: `{ x, y, width, height }`

**é€‰é¡¹ B - å®Œæ•´**ï¼š
- Point
- Box
- Vec2 (å¸¦å‘é‡è¿ç®—: add, sub, length, normalize)
- Matrix (æ”¯æŒ translate/rotate/scale)

**è€ƒè™‘å› ç´ **ï¼š
- Week 2 å®ç° ResizeHandles æ—¶ï¼Œéœ€è¦é€†æ—‹è½¬å˜æ¢
- å¦‚æœ Week 1 ä¸å®ç° Matrixï¼ŒWeek 2 è¦è¡¥ï¼Œä½†è¿”å·¥æˆæœ¬ä¸é«˜
- å»ºè®®ï¼šWeek 1 åªåš Point/Boxï¼ŒWeek 2 æŒ‰éœ€æ·»åŠ  Vec2/Matrix

### 2. å…·ä½“çš„ Shape props è®¾è®¡

**é—®é¢˜**ï¼šRectShape çš„ props åº”è¯¥åŒ…å«ä»€ä¹ˆï¼Ÿ

```typescript
interface RectShape extends BaseShape<'rect', RectProps> {}

interface RectProps {
  width: number
  height: number
  fill: string  // é¢œè‰²å¦‚ä½•è¡¨ç¤ºï¼Ÿ
  stroke: string
  strokeWidth: number
  // è¿˜éœ€è¦ä»€ä¹ˆï¼Ÿ
  // - åœ†è§’åŠå¾„ï¼Ÿ
  // - é˜´å½±ï¼Ÿ
  // - é€æ˜åº¦åœ¨ BaseShape è¿˜æ˜¯ props é‡Œï¼Ÿ
}
```

**å†³ç­–**ï¼š
- å‚è€ƒ Miro çš„çŸ©å½¢å±æ€§é¢æ¿
- å‚è€ƒ tldraw çš„ TLGeoShape props
- å…ˆå®ç°æœ€å°é›†åˆï¼ŒæŒ‰éœ€æ‰©å±•

---

## Architect Mentor è¡Œä¸ºå‡†åˆ™æ›´æ–°

**æ–°å¢è§„åˆ™**ï¼š

> **å®ç°é˜¶æ®µå‡†åˆ™**ï¼š
> 1. **ä¸å¯é€†å†³ç­–**ï¼ˆæ•°æ®æ¨¡å‹ã€ID è®¾è®¡ï¼‰â†’ æå‰æ·±å…¥è®¨è®ºï¼Œé€šè¿‡é—®é¢˜å¼•å¯¼
> 2. **å¯é‡æ„ç»†èŠ‚**ï¼ˆAPIã€ç»„ä»¶ç»“æ„ï¼‰â†’ é¼“åŠ±æœ€ç®€å®ç°ï¼Œé‡åˆ°é—®é¢˜å†ä¼˜åŒ–
> 3. **å¼•å¯¼æ–¹å¼**ï¼šä»ç”¨æˆ·çš„èµ·ç‚¹ï¼ˆå¦‚ Shape å®šä¹‰ï¼‰å‡ºå‘ï¼Œè‡ªç„¶æ¨å¯¼å‡ºä¾èµ–é¡¹ï¼ˆå¦‚ IDï¼‰ï¼Œè€Œä¸æ˜¯ç›´æ¥è¯´"å…ˆå®šä¹‰ ID"
> 4. **é€æ˜æˆæœ¬**ï¼šæ˜ç¡®å‘ŠçŸ¥"é¢„è®¾è®¡æˆæœ¬"å’Œ"è¿”å·¥æˆæœ¬"ï¼Œè®©ç”¨æˆ·è‡ªä¸»é€‰æ‹©

**åæ€**ï¼š
- âŒ ä»Šå¤©çš„é”™è¯¯ï¼šç›´æ¥è¯´"ä» ID å¼€å§‹"ï¼Œç”¨æˆ·æ„Ÿè§‰åƒ"å·²ç»çŸ¥é“æ‰€æœ‰å†…å®¹"
- âœ… æ­£ç¡®åšæ³•ï¼šä» Shape å¼€å§‹ï¼Œå‘ç°éœ€è¦ ID æ—¶ï¼Œå†è®¨è®º ID çš„è®¾è®¡

---

## å‚è€ƒèµ„æ–™

### tldraw æºç ä½ç½®
- ID ç±»å‹å®šä¹‰: `/Users/zhuxiaojiang/great-voyage/guide/tldraw/packages/store/src/lib/BaseRecord.ts`
- Shape å®šä¹‰: `/Users/zhuxiaojiang/great-voyage/guide/tldraw/packages/tlschema/src/records/TLShape.ts`
- ID éªŒè¯å™¨: `/Users/zhuxiaojiang/great-voyage/guide/tldraw/packages/tlschema/src/misc/id-validator.ts`

### æ ¸å¿ƒä»£ç ç‰‡æ®µ
```typescript
// tldraw çš„ RecordId
export type RecordId<R extends UnknownRecord> = string & { __type__: R }

// tldraw çš„ TLShapeId
export type TLShapeId = RecordId<TLUnknownShape>

// åˆ›å»ºå‡½æ•°
export function createShapeId(id?: string): TLShapeId {
  return `shape:${id ?? uniqueId()}` as TLShapeId
}

// ç±»å‹å®ˆå«
export function isShapeId(id?: string): id is TLShapeId {
  return !!id && id.startsWith('shape:')
}
```

---

## Todo åˆ—è¡¨çŠ¶æ€

```
âœ… 1. Create packages/types package.json and tsconfig.json
â¸ï¸ 2. Define geometry types (Point, Box, Transform) - æš‚åœï¼Œç­‰æ˜å¤©ä» Shape è‡ªç„¶æ¨å¯¼
â¸ï¸ 3. Define Shape types (BaseShape, RectShape) - æ˜å¤©çš„èµ·ç‚¹
â¸ï¸ 4. Define Binding types
â¸ï¸ 5. Define Document type
â¸ï¸ 6. Create types package index.ts exports
```

---

## æ˜å¤©å¼€å§‹æ—¶çš„é—®é¢˜

**ç¬¬ä¸€ä¸ªé—®é¢˜**ï¼šä¸€ä¸ªçŸ©å½¢çš„æ•°æ®ç»“æ„åº”è¯¥æ˜¯ä»€ä¹ˆæ ·çš„ï¼Ÿ

```typescript
const rect = {
  // ä½ ä¼šç»™å®ƒä»€ä¹ˆå­—æ®µï¼Ÿåˆ—å‡ºä½ çš„ç›´è§‰
}
```

ä»è¿™ä¸ªèµ·ç‚¹ï¼Œæˆ‘ä»¬ä¼šè‡ªç„¶æ¨å¯¼å‡ºï¼š
1. ä¸ºä»€ä¹ˆéœ€è¦ idï¼Ÿä»€ä¹ˆç±»å‹çš„ idï¼Ÿ
2. ä¸ºä»€ä¹ˆéœ€è¦ geometry ç±»å‹ï¼Ÿ
3. ä¸ºä»€ä¹ˆéœ€è¦ BaseShape æ³›å‹ï¼Ÿ
4. å®Œæ•´çš„ç±»å‹ç³»ç»Ÿæ¶æ„

**è®°ä½**ï¼šä»å…·ä½“åˆ°æŠ½è±¡ï¼Œä»é—®é¢˜åˆ°æ–¹æ¡ˆï¼Œä»éœ€æ±‚åˆ°è®¾è®¡ã€‚

---

## 2024-12-18 æ¶æ„å…¨æ™¯å›¾

### äº§å“ç›®æ ‡

```
äº§å“ï¼šAI ååŒç™½æ¿
åœºæ™¯ï¼šå¤´è„‘é£æš´ + ä¸ªäººæƒ³æ³•è®°å½•ï¼ˆç»“åˆ AIï¼‰

æ ¸å¿ƒéœ€æ±‚ï¼š
â”œâ”€â”€ å®æ—¶åä½œï¼šå¤šäººåŒæ—¶ç¼–è¾‘ï¼Œçœ‹åˆ°å½¼æ­¤æ“ä½œ
â”œâ”€â”€ ç¦»çº¿å¯ç”¨ï¼šæ–­ç½‘ä¹Ÿèƒ½ç”»ï¼Œè”ç½‘ååŒæ­¥
â””â”€â”€ å¤šè®¾å¤‡ï¼šæ‰‹æœºè®°æƒ³æ³•ï¼Œç”µè„‘ç»§ç»­
```

### éœ€æ±‚ â†’ æ¶æ„å†³ç­–é“¾

```
éœ€æ±‚ç»„åˆ                          æŒ‡å‘çš„æ¶æ„
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å®æ—¶ + ç¦»çº¿ + å¤šè®¾å¤‡       â†’      Local-first + CRDT

ä¸ºä»€ä¹ˆï¼Ÿ
â”œâ”€â”€ ä¸­å¿ƒåŒ–æ–¹æ¡ˆï¼šæ–­ç½‘æ— æ³•ç¼–è¾‘ âŒ
â”œâ”€â”€ çº¯å»ä¸­å¿ƒåŒ–ï¼šå®æ—¶æ€§ä¸å¤Ÿ âŒ
â””â”€â”€ Local-firstï¼šæœ¬åœ°ä¼˜å…ˆ + åå°åŒæ­¥ âœ…
    â”œâ”€â”€ åœ¨çº¿æ—¶ï¼šWebSocket å®æ—¶æ¨é€
    â”œâ”€â”€ ç¦»çº¿æ—¶ï¼šæœ¬åœ°å­˜å‚¨ï¼Œç»§ç»­ç¼–è¾‘
    â””â”€â”€ è”ç½‘æ—¶ï¼šCRDT è‡ªåŠ¨åˆå¹¶ï¼Œæ— å†²çª
```

### ä¸ºä»€ä¹ˆç”¨ Map è€Œä¸æ˜¯æ•°ç»„ï¼Ÿ

#### åœºæ™¯ 1ï¼šæŸ¥æ‰¾æ€§èƒ½

```typescript
// æ•°ç»„å­˜å‚¨ - O(n) æŸ¥æ‰¾
const shapes: Shape[] = [...]
function findShape(id: string) {
  return shapes.find(s => s.id === id)  // éå†
}

// Map å­˜å‚¨ - O(1) æŸ¥æ‰¾
const shapes = new Map<string, Shape>()
function findShape(id: string) {
  return shapes.get(id)  // ç›´æ¥å–
}

// æ‹–åŠ¨æ—¶æ¯ç§’ 60 æ¬¡æŸ¥æ‰¾ï¼Œå·®è·å·¨å¤§
```

#### åœºæ™¯ 2ï¼šåˆ é™¤ç¨³å®šæ€§

```typescript
// æ•°ç»„ï¼šåˆ é™¤ä¼šå½±å“åç»­ç´¢å¼•
shapes = [A, B, C]  // index: 0, 1, 2
shapes.splice(1, 1)  // åˆ é™¤ B
// ç»“æœï¼š[A, C]ï¼ŒC çš„ index ä» 2 å˜æˆ 1

// Mapï¼šåˆ é™¤ä¸å½±å“å…¶ä»–å…ƒç´ 
shapes.delete('shape:B')
// A å’Œ C çš„ key ä¸å˜
```

#### åœºæ™¯ 3ï¼šååŒå†²çª

```typescript
// æ•°ç»„ + ä¸¤ä¸ªç”¨æˆ·åŒæ—¶åˆ é™¤
// åˆå§‹ï¼šshapes = [A, B, C]
// ç”¨æˆ· X å‘é€ï¼š{ action: 'delete', index: 1 }  // åˆ  B
// ç”¨æˆ· Y å‘é€ï¼š{ action: 'delete', index: 2 }  // åˆ  C
//
// æœåŠ¡å™¨æŒ‰é¡ºåºæ‰§è¡Œï¼š
// 1. åˆ é™¤ index 1 â†’ [A, C]
// 2. åˆ é™¤ index 2 â†’ ğŸ’¥ è¶Šç•Œæˆ–åˆ é”™ï¼
//
// éœ€è¦ OT æ¥è½¬æ¢æ“ä½œ

// Map + ä¸¤ä¸ªç”¨æˆ·åŒæ—¶åˆ é™¤
// ç”¨æˆ· X å‘é€ï¼š{ action: 'delete', id: 'shape:B' }
// ç”¨æˆ· Y å‘é€ï¼š{ action: 'delete', id: 'shape:C' }
//
// ä»»æ„é¡ºåºæ‰§è¡Œï¼Œéƒ½æ­£ç¡® âœ…
// ä¸éœ€è¦ OT
```

### Shape å®Œæ•´ç»“æ„

```typescript
interface BaseShape<Type extends string, Props extends object> {
  // å”¯ä¸€æ ‡è¯†
  id: ShapeId              // branded typeï¼Œç±»å‹å®‰å…¨
  type: Type               // 'rect' | 'circle' | 'text' | ...

  // å˜æ¢å±æ€§ï¼ˆå¹³é“ºï¼Œæ‰€æœ‰ shape å…±æœ‰ï¼‰
  x: number
  y: number
  rotation: number

  // å±‚çº§å…³ç³»ï¼ˆCRDT å‹å¥½ï¼‰
  index: string            // fractional indexing
  parentId: ShapeId | null // æŒ‡å‘çˆ¶å…ƒç´ 

  // ç‰¹æœ‰å±æ€§
  props: Props
}

// ç¤ºä¾‹ï¼šçŸ©å½¢
interface RectShape extends BaseShape<'rect', RectProps> {}
interface RectProps {
  width: number
  height: number
  fill: string
  // ...
}
```

### Store é€‚é…å™¨æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           ä½ çš„ä¸šåŠ¡ä»£ç                     â”‚
â”‚  (åˆ›å»º Shapeã€ç§»åŠ¨ã€åˆ é™¤ã€åˆ†ç»„...)         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚ è°ƒç”¨
                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           Store æ¥å£                     â”‚
â”‚  add(shape), update(id, changes),       â”‚
â”‚  delete(id), get(id), transaction(...), â”‚
â”‚  subscribe(callback)                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚ å®ç°
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â–¼                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  YjsAdapter  â”‚    â”‚ CustomAdapter â”‚
â”‚  (ç°åœ¨ç”¨)     â”‚    â”‚  (å°†æ¥è‡ªç ”)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å®Œæ•´æ•°æ®æµ

```
ç”¨æˆ·æ“ä½œï¼šæ‹–åŠ¨ä¸€ä¸ªçŸ©å½¢
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1. äº¤äº’å±‚                                                  â”‚
â”‚     canvas.onDrag() â†’ è®¡ç®—æ–°ä½ç½®                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ store.update('shape:1', { x: 200, y: 150 })
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  2. Store å±‚                                                â”‚
â”‚     â”œâ”€â”€ éªŒè¯å˜æ›´                                            â”‚
â”‚     â”œâ”€â”€ åº”ç”¨åˆ°æœ¬åœ°çŠ¶æ€ï¼ˆç«‹å³ç”Ÿæ•ˆï¼Œä¸ç­‰ç½‘ç»œï¼‰                   â”‚
â”‚     â””â”€â”€ é€šçŸ¥æ‰€æœ‰è®¢é˜…è€…                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â–¼                                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  3a. æ¸²æŸ“ç³»ç»Ÿ        â”‚              â”‚  3b. ååŒç³»ç»Ÿ        â”‚
â”‚  â””â”€â”€ é‡ç»˜ç”»å¸ƒ        â”‚              â”‚  â””â”€â”€ å‘é€åˆ°æœåŠ¡å™¨     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                                     â”‚
         â–¼                                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç”¨æˆ·ç«‹åˆ»çœ‹åˆ°        â”‚              â”‚  å…¶ä»–ç”¨æˆ·æ”¶åˆ°å˜æ›´     â”‚
â”‚  çŸ©å½¢ç§»åŠ¨äº†          â”‚              â”‚  ä»–ä»¬çš„ç”»å¸ƒä¹Ÿæ›´æ–°     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Transaction çš„ä½œç”¨

```typescript
// ç”¨æˆ·æ“ä½œï¼šæŠŠ 3 ä¸ª shape ç¼–ç»„
// è¿™æ˜¯ä¸€ä¸ª"åŸå­æ“ä½œ"

store.transaction(() => {
  const groupId = createId()
  store.add({ id: groupId, type: 'group', ... })
  store.update('shape:1', { parentId: groupId })
  store.update('shape:2', { parentId: groupId })
  store.update('shape:3', { parentId: groupId })
})

// 1. å¯¹äº Undoï¼šè¿™ 4 ä¸ªæ“ä½œä½œä¸ºä¸€ä¸ªæ•´ä½“æ’¤é”€
// 2. å¯¹äºååŒï¼šè¿™ 4 ä¸ªæ“ä½œæ‰“åŒ…å‘é€
// 3. å¯¹äºæ¸²æŸ“ï¼šåªè§¦å‘ä¸€æ¬¡é‡ç»˜ï¼Œè€Œä¸æ˜¯ 4 æ¬¡
```

### è®¢é˜…æ¨¡å¼

```typescript
// å¤šä¸ªè®¢é˜…è€…ï¼Œå„è‡ªå¤„ç†å˜æ›´

// 1. æ¸²æŸ“ç³»ç»Ÿ
store.subscribe((changes) => canvas.render())

// 2. Undo/Redo ç³»ç»Ÿ
store.subscribe((changes) => history.record(changes))

// 3. ååŒæ¨¡å—
store.subscribe((changes) => sync.broadcast(changes))

// 4. AI æ¨¡å—ï¼ˆæœªæ¥ï¼‰
store.subscribe((changes) => ai.analyze(changes))
```

### æŠ€æœ¯æ ˆå¯¹åº”

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       ç™½æ¿æ¶æ„                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚      å±‚çº§        â”‚              æŠ€æœ¯é€‰æ‹©                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ç±»å‹å®šä¹‰        â”‚  TypeScript + Branded Types             â”‚
â”‚                  â”‚  packages/types/                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  çŠ¶æ€ç®¡ç†        â”‚  Store æ¥å£ + YjsAdapter                â”‚
â”‚                  â”‚  (ä¿ç•™è‡ªç ”ç©ºé—´)                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ååŒå¼•æ“        â”‚  Yjs (CRDT)                             â”‚
â”‚                  â”‚  + y-websocket (å®æ—¶åŒæ­¥)               â”‚
â”‚                  â”‚  + y-indexeddb (ç¦»çº¿å­˜å‚¨)               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  æ¸²æŸ“å±‚          â”‚  Canvas 2D / WebGL (å¾…å®š)               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  äº¤äº’å±‚          â”‚  React + äº‹ä»¶å¤„ç† (å¾…å®š)                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  AI é›†æˆ         â”‚  å¾…è®¾è®¡                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2024-12-18 å®ç°è¿›åº¦

### ä»Šæ—¥å®Œæˆ

**âœ… ids.ts å®ç°å®Œæˆ**

å®ç°å†…å®¹ï¼š
- âœ… 5 ç§ Branded Type ID å®šä¹‰ï¼ˆShapeId, BindingId, AssetId, DocumentId, UserIdï¼‰
- âœ… ID ç”Ÿæˆå‡½æ•°ï¼ˆä½¿ç”¨ crypto.randomUUID()ï¼‰
- âœ… 5 ä¸ªåˆ›å»ºå‡½æ•°ï¼ˆcreateShapeId, createBindingId ç­‰ï¼‰
- âœ… 5 ä¸ªç±»å‹å®ˆå«ï¼ˆisShapeId, isBindingId ç­‰ï¼‰
- âœ… å®Œæ•´çš„ JSDoc æ³¨é‡Š

å…³é”®å†³ç­–ï¼š
1. **Branded Type åŸç†å­¦ä¹ **ï¼šç†è§£äº†å¦‚ä½•ç”¨ `string & { readonly __brand: 'Type' }` å®ç°ç¼–è¯‘æ—¶ç±»å‹å®‰å…¨
2. **åŒ…èŒè´£è¾¹ç•Œ**ï¼šå†³å®šå°†ç±»å‹å’Œç›¸å…³æ“ä½œå‡½æ•°æ”¾åœ¨ä¸€èµ·ï¼ˆå†…èšæ€§ä¼˜å…ˆï¼‰
3. **ID æ ¼å¼**ï¼š`prefix:uuid` æ ¼å¼ï¼ˆå¦‚ `shape:550e8400-e29b-41d4-a716-446655440000`ï¼‰
4. **ID ç”Ÿæˆç­–ç•¥**ï¼šä½¿ç”¨ `crypto.randomUUID()`ï¼Œä¸åŒ…å« clientIdï¼ˆç®€å•ä¼˜å…ˆï¼ŒclientId åœ¨éœ€è¦æ—¶å•ç‹¬ä¼ é€’ï¼‰
5. **å…¼å®¹æ€§æ–¹æ¡ˆ**ï¼šé€‰æ‹©æœ€ç®€å•æ–¹æ¡ˆï¼Œè¦æ±‚ Node.js 15.6+ æˆ–ç°ä»£æµè§ˆå™¨

æ–‡ä»¶ä½ç½®ï¼š`packages/types/src/ids.ts` (170 è¡Œ)

---

## æ›´æ–°åçš„ Todo åˆ—è¡¨

```
âœ… 1. Create packages/types package.json and tsconfig.json
âœ… 2. å®Œæˆæ‰€æœ‰æ¶æ„å†³ç­–
âœ… 3. Define ID types (ids.ts) - å·²å®Œæˆ
â³ 4. Define geometry types (geometry.ts) - ä¸‹ä¸€æ­¥
â³ 5. Define Shape types (shapes.ts)
â³ 6. Define Binding types (bindings.ts)
â³ 7. Define Store interface (store.ts)
â³ 8. Create index.ts exports
```

---

## ä¸‹æ¬¡å¼€å§‹æ—¶

ä» `packages/types/src/geometry.ts` å¼€å§‹ï¼Œéœ€è¦æ€è€ƒï¼š

### éœ€è¦å®ç°çš„å‡ ä½•ç±»å‹

æ ¹æ®æ¶æ„å†³ç­–ï¼Œå˜æ¢å±æ€§ï¼ˆx, y, rotationï¼‰ç›´æ¥å¹³é“ºåœ¨ Shape é¡¶å±‚ï¼Œå› æ­¤ geometry.ts åº”è¯¥åŒ…å«ï¼š

**åŸºç¡€ç±»å‹**ï¼š
- `Point` - ç‚¹åæ ‡ `{ x, y }`
- `Vec2` - äºŒç»´å‘é‡ï¼ˆä¸ Point çš„åŒºåˆ«ï¼Ÿï¼‰
- `Box` - çŸ©å½¢è¾¹ç•Œæ¡† `{ x, y, width, height }`

**å¾…è®¨è®º**ï¼š
- Point å’Œ Vec2 æ˜¯åŒä¸€ä¸ªç±»å‹è¿˜æ˜¯åˆ†å¼€ï¼Ÿ
- æ˜¯å¦éœ€è¦ Transform ç±»å‹ï¼Ÿï¼ˆè€ƒè™‘åˆ° x, y, rotation å·²ç»å¹³é“ºï¼‰
- æ˜¯å¦éœ€è¦å…¶ä»–å‡ ä½•ç±»å‹ï¼Ÿï¼ˆCircle, Line, Polygon ç­‰ï¼‰

**å‚è€ƒèµ„æ–™**ï¼š
- æŸ¥çœ‹è¿›åº¦æ–‡ä»¶ä¸­çš„æ¶æ„å†³ç­–éƒ¨åˆ† (line 403)
- tldraw çš„å‡ ä½•ç±»å‹å®šä¹‰

---

## 2024-12-19 å®ç°è¿›åº¦

### ä»Šæ—¥å®Œæˆ

**âœ… geometry.ts å®ç°å®Œæˆ**

å®ç°å†…å®¹ï¼š
- âœ… Point ç±»å‹ï¼ˆBranded Typeï¼‰+ å·¥å…·å‡½æ•°ï¼ˆcreate, distance, midpoint, translate, subtractï¼‰
- âœ… Vec2 ç±»å‹ï¼ˆBranded Typeï¼‰+ å·¥å…·å‡½æ•°ï¼ˆcreate, add, sub, lengthï¼‰
- âœ… Box ç±»å‹ï¼ˆx, y, width, height, rotationï¼‰+ å·¥å…·å‡½æ•°ï¼ˆcreate, contains, intersectsï¼‰
- âœ… BoxBounds å†…éƒ¨è¾…åŠ©ç±»å‹

å…³é”®å†³ç­–ï¼š
1. **Point å’Œ Vec2 åˆ†å¼€**ï¼šè¯­ä¹‰ä¸åŒï¼ˆä½ç½® vs ä½ç§»ï¼‰ï¼Œä½¿ç”¨ Branded Type åŒºåˆ†
2. **Branded Type æ··åˆæ–¹å¼**ï¼šç±»å‹å®šä¹‰ç”¨å¿…é¡»çš„ `__brand`ï¼Œå®ç°ç”¨ `as` æ–­è¨€ï¼ˆè¿è¡Œæ—¶é›¶å¼€é”€ï¼‰
3. **Box éœ€è¦ rotation**ï¼šç”¨äº OBBï¼ˆOriented Bounding Boxï¼‰ï¼Œæ”¯æŒæ—‹è½¬åçš„é€‰åŒºè¾¹æ¡†
4. **å‘½åç©ºé—´é£æ ¼**ï¼š`Point.create()`, `Vec2.add()` è€Œä¸æ˜¯ class æ–¹æ³•
5. **Box æ˜¯å‡ ä½•å·¥å…·ï¼Œä¸æ˜¯ Shape**ï¼šç”¨äºç¢°æ’æ£€æµ‹ã€æ¡†é€‰è®¡ç®—ï¼Œä¸å­˜å‚¨

æ–‡ä»¶ä½ç½®ï¼š`packages/types/src/geometry.ts` (86 è¡Œ)

---

**âœ… shapes.ts å®ç°å®Œæˆ**

å®ç°å†…å®¹ï¼š
- âœ… BaseShape<Type, Props> æ³›å‹åŸºç±»
- âœ… RectShapeï¼ˆwidth, height, fill, stroke, strokeWidthï¼‰
- âœ… LineShapeï¼ˆendX, endY, stroke, strokeWidthï¼‰
- âœ… GroupShapeï¼ˆç©º propsï¼‰
- âœ… Shape è”åˆç±»å‹

å…³é”®å†³ç­–ï¼š
1. **å­—ç¬¦ä¸²å­—é¢é‡è€Œé enum**ï¼šæ”¯æŒæ’ä»¶æ‰©å±•ï¼Œç¬¬ä¸‰æ–¹å¯ä»¥å®šä¹‰è‡ªå®šä¹‰ shape ç±»å‹
2. **BaseShape å¯¼å‡º**ï¼šå¤–éƒ¨å¯ä»¥ä½¿ç”¨æ³›å‹çº¦æŸ
3. **isLocked åœ¨ BaseShape**ï¼šæ‰€æœ‰ shape å…±æœ‰çš„å±æ€§
4. **Line vs Connector**ï¼šLine æ˜¯ç®€å•ç›´çº¿ï¼ŒConnector æ˜¯å¸¦ Binding çš„è¿æ¥çº¿ï¼ˆåç»­å®ç°ï¼‰
5. **LineShape çš„ endX, endY æ˜¯ç›¸å¯¹åç§»**ï¼šç›¸å¯¹äºèµ·ç‚¹ (x, y)ï¼Œæ‹–åŠ¨æ—¶åªéœ€æ›´æ–° x, y
6. **Rect çš„ x, y æ˜¯ä¸­å¿ƒç‚¹**ï¼šMiro é£æ ¼ï¼Œæ—‹è½¬æ—¶ä»¥ä¸­å¿ƒä¸ºåŸç‚¹

æ–‡ä»¶ä½ç½®ï¼š`packages/types/src/shapes.ts` (40 è¡Œ)

---

### å…³é”®æ¦‚å¿µå­¦ä¹ 

#### å½’ä¸€åŒ–åæ ‡ï¼ˆNormalizedPointï¼‰

**ç”¨é€”**ï¼šBinding çš„ anchor ä½ç½®ï¼Œç”¨ 0-1 æ¯”ä¾‹è¡¨ç¤º shape è¾¹ç•Œä¸Šçš„ä½ç½®

```typescript
// å½’ä¸€åŒ–åæ ‡
{ x: 0, y: 0 }     // å·¦ä¸Šè§’
{ x: 1, y: 0 }     // å³ä¸Šè§’
{ x: 0.5, y: 0.5 } // ä¸­å¿ƒ
{ x: 1, y: 0.5 }   // å³è¾¹ä¸­ç‚¹

// è½¬æ¢ä¸ºä¸–ç•Œåæ ‡ï¼ˆè€ƒè™‘æ—‹è½¬ï¼‰
// 1. å½’ä¸€åŒ– â†’ å±€éƒ¨åæ ‡ï¼ˆç›¸å¯¹äº shape ä¸­å¿ƒï¼‰
const localX = (anchor.x - 0.5) * width
const localY = (anchor.y - 0.5) * height

// 2. åº”ç”¨æ—‹è½¬
const rotatedX = localX * cos(rotation) - localY * sin(rotation)
const rotatedY = localX * sin(rotation) + localY * cos(rotation)

// 3. åŠ ä¸Š shape çš„ä¸–ç•Œåæ ‡
const worldX = shape.x + rotatedX
const worldY = shape.y + rotatedY
```

**ä¸ºä»€ä¹ˆç”¨å½’ä¸€åŒ–åæ ‡**ï¼š
- shape ç¼©æ”¾æ—¶ï¼Œanchor ä½ç½®è‡ªåŠ¨è·Ÿéšï¼ˆ"å³è¾¹ä¸­ç‚¹"å§‹ç»ˆæ˜¯å³è¾¹ä¸­ç‚¹ï¼‰
- å­˜å‚¨çš„æ˜¯è¯­ä¹‰ä½ç½®ï¼Œä¸æ˜¯ç»å¯¹åƒç´ å€¼

---

### Binding è®¾è®¡è®¨è®ºï¼ˆå¾…å®ç°ï¼‰

**æ ¸å¿ƒæ¦‚å¿µ**ï¼šBinding æ˜¯ç‹¬ç«‹çš„"ç»‘å®šå…³ç³»"ï¼Œè®© Line çš„ç«¯ç‚¹è·Ÿéšå¦ä¸€ä¸ª shape

```typescript
interface Binding {
  id: BindingId
  fromId: ShapeId        // å“ªä¸ª shapeï¼ˆæ¯”å¦‚ Lineï¼‰
  fromTerminal: ???      // å“ªä¸ªç«¯ç‚¹ï¼Ÿèµ·ç‚¹è¿˜æ˜¯ç»ˆç‚¹ï¼Ÿ
  toId: ShapeId          // ç»‘å®šåˆ°å“ªä¸ª shapeï¼ˆæ¯”å¦‚ Rectï¼‰
  anchor: NormalizedPoint // ç»‘å®šä½ç½®ï¼ˆå½’ä¸€åŒ–åæ ‡ï¼‰
}
```

**å¾…å†³å®š**ï¼š
- `fromTerminal` çš„ç±»å‹ï¼š`'start' | 'end'`ï¼Ÿè¿˜æ˜¯å…¶ä»–æ–¹å¼ï¼Ÿ
- `NormalizedPoint` æ”¾åœ¨ geometry.ts è¿˜æ˜¯ bindings.tsï¼Ÿ

---

## æ›´æ–°åçš„ Todo åˆ—è¡¨

```
âœ… 1. Create packages/types package.json and tsconfig.json
âœ… 2. å®Œæˆæ‰€æœ‰æ¶æ„å†³ç­–
âœ… 3. Define ID types (ids.ts)
âœ… 4. Define geometry types (geometry.ts)
âœ… 5. Define Shape types (shapes.ts)
â³ 6. Define Binding types (bindings.ts) - ä¸‹ä¸€æ­¥
â³ 7. Define Store interface (store.ts)
â³ 8. Create index.ts exports
```

---

## ä¸‹æ¬¡å¼€å§‹æ—¶

ä» `packages/types/src/bindings.ts` å¼€å§‹ï¼š

**éœ€è¦å®ç°**ï¼š
1. `NormalizedPoint` ç±»å‹ï¼ˆå¯èƒ½æ”¾åœ¨ geometry.tsï¼‰
2. `Binding` æ¥å£
3. `fromTerminal` çš„ç±»å‹å®šä¹‰

**è®¾è®¡é—®é¢˜**ï¼š
```typescript
interface Binding {
  id: BindingId
  fromId: ShapeId
  fromTerminal: 'start' | 'end'  // æˆ–è€…å…¶ä»–æ–¹å¼ï¼Ÿ
  toId: ShapeId
  anchor: NormalizedPoint
}
```

**è®°ä½**ï¼š
- Binding è®© Line çš„ç«¯ç‚¹"è·Ÿéš" shape
- Line æœ¬èº«ä¸çŸ¥é“è‡ªå·±è¢«ç»‘å®šäº†
- å½“ shape ç§»åŠ¨æ—¶ï¼Œç³»ç»ŸæŸ¥è¯¢ Binding è¡¨ï¼Œæ›´æ–° Line çš„ç«¯ç‚¹åæ ‡

---